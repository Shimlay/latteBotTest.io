<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile Management</title>
</head>
<body>
    <h1>Управление профилем</h1>
    <form id="profileForm">
        <label for="fio">ФИО:</label>
        <input type="text" id="fio" name="fio" required><br>

        <label for="profession">Профессия:</label>
        <input type="text" id="profession" name="profession" required><br>

        <label for="about">О себе:</label>
        <textarea id="about" name="about" required></textarea><br>

        <label for="photo_url">URL фото:</label>
        <input type="url" id="photo_url" name="photo_url" required><br>

        <button type="button" id="saveProfileButton">Сохранить профиль</button>
    </form>

    <h2>Список всех анкет</h2>
    <div id="profileList"></div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script>
        // Инициализация Telegram Web App SDK
        const tg = window.Telegram.WebApp;

        // Функция сохранения профиля
        function saveProfile(profile) {
            tg.CloudStorage.getItem('userProfiles', (error, storedProfiles) => {
                if (error) {
                    console.error('Ошибка при получении данных из Cloud Storage:', error);
                    return;
                }

                let profiles = [];
                if (storedProfiles) {
                    profiles = JSON.parse(storedProfiles);
                }

                const existingProfileIndex = profiles.findIndex(p => p.userId === profile.userId);
                if (existingProfileIndex > -1) {
                    profiles[existingProfileIndex] = profile;
                } else {
                    profiles.push(profile);
                }

                tg.CloudStorage.setItem('userProfiles', JSON.stringify(profiles), (error, success) => {
                    if (error) {
                        console.error('Ошибка при сохранении данных в Cloud Storage:', error);
                        alert('Ошибка при сохранении данных. Пожалуйста, попробуйте снова.');
                        return;
                    }
                    console.log('Profile saved successfully:', success);
                    alert('Профиль успешно сохранен!');
                    showAllProfiles();  // Обновить список анкет после сохранения
                });
            });
        }

        // Функция отображения всех анкет
        function showAllProfiles() {
            tg.CloudStorage.getItem('userProfiles', (error, data) => {
                if (error) {
                    console.error('Ошибка при получении данных из Cloud Storage:', error);
                    return;
                }
                if (data) {
                    const profiles = JSON.parse(data);
                    let profileListHtml = '<ul>';
                    profiles.forEach(profile => {
                        profileListHtml += `
                            <li>
                                <strong>${profile.fio}</strong><br>
                                Профессия: ${profile.profession}<br>
                                О себе: ${profile.about}<br>
                                <img src="${profile.photo_url}" alt="${profile.fio}" style="max-width: 100px; max-height: 100px;"><br>
                            </li>
                        `;
                    });
                    profileListHtml += '</ul>';
                    document.getElementById("profileList").innerHTML = profileListHtml;
                } else {
                    document.getElementById("profileList").innerText = 'Нет анкет для отображения.';
                }
            });
        }

        // Обработчик кнопки сохранения профиля
        document.getElementById("saveProfileButton").addEventListener("click", () => {
            const profile = {
                userId: tg.initDataUnsafe.user.id,  // Уникальный идентификатор пользователя Telegram
                fio: document.getElementById("fio").value,
                profession: document.getElementById("profession").value,
                about: document.getElementById("about").value,
                photo_url: document.getElementById("photo_url").value
            };
            saveProfile(profile);
        });

        // Вызов функции для отображения всех профилей при загрузке страницы
        showAllProfiles();
    </script>
</body>
</html>
